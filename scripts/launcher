#!/bin/bash
set -euo pipefail

# Locate bundled resources relative to this launcher
APP_ROOT="$(cd "$(dirname "$0")/.." && pwd)"
RES_DIR="${APP_ROOT}/Resources"
LOG_DIR="${HOME}/Library/Logs/MultiChrome"
LOG_FILE="${LOG_DIR}/run.log"

mkdir -p "${LOG_DIR}"

SCRIPT_PATH="${RES_DIR}/multi_chrome.sh"

if [[ ! -x "${SCRIPT_PATH}" ]]; then
    echo "[MultiChrome] Script not found: ${SCRIPT_PATH}" | tee -a "${LOG_FILE}"
    /usr/bin/osascript -e 'display notification "脚本缺失" with title "MultiChrome"'
    exit 1
fi

# Enrich PATH for Homebrew and system locations
export PATH="/opt/homebrew/bin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin:${PATH}"

# If arguments are provided (open -a MultiChrome --args ...), pass-through
if [[ $# -gt 0 ]]; then
    exec "${SCRIPT_PATH}" "$@" >> "${LOG_FILE}" 2>&1
fi

# No arguments: present a simple AppleScript UI for beginners

choose_cmd() {
    /usr/bin/osascript <<'APPLESCRIPT'
set cmdList to {"启动指定数量", "启动指定编号", "启动区间编号", "查看状态", "关闭全部", "关闭指定编号", "关闭区间编号", "帮助"}
set sel to choose from list cmdList with prompt "选择操作" default items {"启动指定数量"} OK button name "确定" cancel button name "取消" with title "MultiChrome"
if sel is false then return ""
set choice to item 1 of sel
if choice is "启动指定数量" then return "count"
if choice is "启动指定编号" then return "start_one"
if choice is "启动区间编号" then return "start_range"
if choice is "查看状态" then return "status"
if choice is "关闭全部" then return "kill_all"
if choice is "关闭指定编号" then return "kill_one"
if choice is "关闭区间编号" then return "kill_range"
return "help"
APPLESCRIPT
}

prompt_number() {
    /usr/bin/osascript <<'APPLESCRIPT'
set dlg to display dialog "输入实例数量 (1-20)" default answer "3" buttons {"取消", "确定"} default button "确定"
set txt to text returned of dlg
return txt
APPLESCRIPT
}

prompt_instance() {
    /usr/bin/osascript <<'APPLESCRIPT'
set dlg to display dialog "输入实例编号 (1-999)" default answer "1" buttons {"取消", "确定"} default button "确定"
set txt to text returned of dlg
return txt
APPLESCRIPT
}

prompt_range() {
    /usr/bin/osascript <<'APPLESCRIPT'
set startDlg to display dialog "输入起始实例编号 (1-999)" default answer "1" buttons {"取消", "确定"} default button "确定"
set startNum to text returned of startDlg
set endDlg to display dialog "输入结束实例编号 (1-999)" default answer "5" buttons {"取消", "确定"} default button "确定"
set endNum to text returned of endDlg
return startNum & "-" & endNum
APPLESCRIPT
}

ACTION="$(choose_cmd || true)"

if [[ -z "${ACTION}" ]]; then
    exit 0
fi

case "${ACTION}" in
    count)
        NUM="$(prompt_number || true)"
        if [[ -z "${NUM}" ]]; then exit 0; fi
        exec "${SCRIPT_PATH}" "${NUM}" >> "${LOG_FILE}" 2>&1 ;;
    start_one)
        N="$(prompt_instance || true)"
        if [[ -z "${N}" ]]; then exit 0; fi
        exec "${SCRIPT_PATH}" -n "${N}" >> "${LOG_FILE}" 2>&1 ;;
    start_range)
        RANGE="$(prompt_range || true)"
        if [[ -z "${RANGE}" ]]; then exit 0; fi
        exec "${SCRIPT_PATH}" -r "${RANGE}" >> "${LOG_FILE}" 2>&1 ;;
    status)
        OUTPUT="$(${SCRIPT_PATH} -s 2>&1)" || true
        printf "%s\n" "${OUTPUT}" >> "${LOG_FILE}"
        TMP_FILE="$(mktemp)"
        printf "%s\n" "${OUTPUT}" > "${TMP_FILE}"
        /usr/bin/osascript <<APPLESCRIPT
set preview to do shell script "cat " & quoted form of POSIX path of "${TMP_FILE}"
display dialog preview buttons {"关闭","打开日志"} default button "关闭" with title "MultiChrome"
if button returned of result is "打开日志" then do shell script "open -a TextEdit " & quoted form of POSIX path of "${LOG_FILE}"
APPLESCRIPT
        rm -f "${TMP_FILE}"
        exit 0 ;;
    kill_all)
        exec "${SCRIPT_PATH}" -k >> "${LOG_FILE}" 2>&1 ;;
    kill_one)
        N="$(prompt_instance || true)"
        if [[ -z "${N}" ]]; then exit 0; fi
        exec "${SCRIPT_PATH}" -k "${N}" >> "${LOG_FILE}" 2>&1 ;;
    kill_range)
        RANGE="$(prompt_range || true)"
        if [[ -z "${RANGE}" ]]; then exit 0; fi
        exec "${SCRIPT_PATH}" -K "${RANGE}" >> "${LOG_FILE}" 2>&1 ;;
    help|*)
        HELP_OUT="$(${SCRIPT_PATH} -h 2>&1)" || true
        printf "%s\n" "${HELP_OUT}" >> "${LOG_FILE}"
        TMP_FILE="$(mktemp)"
        printf "%s\n" "${HELP_OUT}" > "${TMP_FILE}"
        /usr/bin/osascript <<APPLESCRIPT
set preview to do shell script "cat " & quoted form of POSIX path of "${TMP_FILE}"
display dialog preview buttons {"关闭","打开日志"} default button "关闭" with title "MultiChrome"
if button returned of result is "打开日志" then do shell script "open -a TextEdit " & quoted form of POSIX path of "${LOG_FILE}"
APPLESCRIPT
        rm -f "${TMP_FILE}"
        exit 0 ;;
esac


